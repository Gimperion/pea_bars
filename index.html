<!DOCTYPE html>
<!-- Data Visualization by Tommy Shen
	Bloomberg BNA
	Data from FCC Incentive Auction 126 MHz, Forward Auction
	https://auctiondata.fcc.gov/public/projects/1000/reports/product_status-stage1
 -->
<html>
<meta charset="utf-8">
<style>
body {
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
	position: relative;
	background-color: #011;
}

div.tooltip {
	position: absolute;
	text-align: center;
	padding: 3px;
	font: 14px sans-serif;
	background: #CFF;
	border: 0px;
	border-radius: 8px;
	pointer-events: none;
}

.bar:hover{ fill: #66F;}


a:hover {color: #CFF;}

.axis text {
	font: 10px sans-serif;
	fill: white;
	background-color: #011;
}

.tick { fill: white;}

.axis path,
.axis line {
	stroke: #CCC;
	shape-rendering: crispEdges;
	fill: #021;
}

.bar {
	fill-opacity: .92;
}

.x.axis path {
	display: none;
}

label {
	position: absolute;
	top: 680px;
	left: 80px;
	color: #FFF;
	font-size: 1.2em;
	padding: 11px 0px 11px 0px;
}

#rselect {
	width: 400px;
	margin-top: 10px;
	display:inline-block;
}

</style>
<body>
<h1 style="color:#FFF;">FCC Incentive Auction (Forward Auction, Stage 1) </h1>
<p style="color:#FFF;">A plot of bidding activities by Partial Economic Areas across 27 rounds of bidding. <br />
</p>

<label for="rselect">Round
	<input type="range" id="rselect" min="1" value="1" max="27" step="1">
	<button type="button" id="start">start</button>
	<button type="button" id="stop">stop</button>
</label>


<script src="//d3js.org/d3.v3.min.js"></script>
<script>
var round_text = ["Auction starts with concentrated demand in top 10 markets.",
	"Bidding shifts into the top 35.",
	"Smaller markets start to come into play.",
	"Bidding driven by NY and LA and smaller markets.",
	"Bidding falls off while Eagle Pass, TX spikes."];

var margin = {top: 50, right: 20, bottom: 70, left: 20},
	width = 1350 - margin.left - margin.right,
	height = 650 - margin.top - margin.bottom;

var x = d3.scale.ordinal().rangeRoundBands([0, width], .5);

var y = d3.scale.linear().range([height, 0]);

var xAxis = d3.svg.axis()
	.scale(x)
	.orient("bottom")
	.tickFormat(function (d) { return ''; });

var yAxis = d3.svg.axis()
	.scale(y)
	.orient("left")
	.innerTickSize(-width)
	.outerTickSize(0);

var div = d3.select("body").append("div")
	.attr("class", "tooltip")
	.style("opacity", 0);

var svg = d3.select("body").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
	.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var colors = d3.scale.linear()
	.domain([0.000, 1.75])
	.range(["#FFEF80", "#A00040"])
	.clamp(true);

var cscale = d3.scale.linear()
	.domain([0.000, 1.75])
	.range([200,0])
	.clamp(true);

var key = d3.select("body").append("svg")
	.attr("width", 80).attr("height", 500);

var legend = key.append("defs")
	.append("svg:linearGradient")
	.attr("id", "gradient")
	.attr("x1", "100%")
	.attr("y1", "0%")
	.attr("x2", "100%")
	.attr("y2", "100%")
	.attr("spreadMethod", "pad");

var title = svg.append("g")
		.attr("class", "title")
	.append("text")
		.attr("x", (width / 2))
		.attr("y", 15 - (margin.top / 2))
		.attr("text-anchor", "middle")
		.style("font-size", "22px")
		.style("fill", "white");

var summary = svg.append("g")
		.attr("class", "summary")
	.append("text")
		.attr("x", width / 2)
		.attr("y", height - 6)
		.attr("text-anchor", "middle")
		.style("font-size", "18px")
		.style("fill", "white");

d3.csv("data.csv", function(error, data) {
	data.forEach(function(d) {
		d.round = +d.round;
		d.price_mhz_pop = +d.price_mhz_pop;
		d.net_surplus = +d.net_surplus;
	});

	x.domain(data.map(function(d) { return d.key; }));
	y.domain([-10, d3.max(data, function(d) { return d.net_surplus; })]);


	legend.append("stop").attr("offset", "0%").attr("stop-color", "#A00040").attr("stop-opacity", 1);
	legend.append("stop").attr("offset", "100%").attr("stop-color", "#FFEF80").attr("stop-opacity", 1);

	key.append("rect").attr("width", 15)
		.attr("height", 200)
		.attr("transform", "translate(0,40)")
		.style("fill", "url(#gradient)");

	var miniAxis = d3.svg.axis().scale(cscale)
		.orient("right")
		.tickValues([0,.25,.50,.75,1,1.25,1.5,1.75])
		.tickFormat(d3.format("$,.02f"))
		.tickSize(20,0);

	key.append("g")
		.attr("class", "y axis")
		.attr("transform", "translate(0,40)")
		.call(miniAxis)
	.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 65)
		.style("text-anchor", "end")
		.text("Price/Mhz/Pop");


	svg.append("g")
		.attr("class", "y axis")
		.call(yAxis)
	.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", ".8em")
		.style("text-anchor", "end")
		.text("Net Surplus");

	title.text(function(){ return "Round " +  document.getElementById("rselect").value});
	summary.text(round_text[0]);

	svg.selectAll(".bar")
		.data(data.filter(function(d) { return d.round == +document.getElementById("rselect").value}))
	.enter().append("rect")
		.attr("class", "bar")
		.attr("fill", function(d) { return colors(d.price_mhz_pop)})
		.attr("x", function(d) { return x(d.key); })
		.attr("width", x.rangeBand())
		.attr("y", function(d) {
			if(d.net_surplus == 0){
				console.log(y(0) + 50);
				return (y(0)-2);
			} else{
				return y(Math.max(0, d.net_surplus));
			}
		})
		.attr("height", function(d) {
			if(d.net_surplus==0){
				return 4;
			} else{
				return Math.max(y(0) - y(d.net_surplus),y(d.net_surplus) - y(0));
			}
		})
		.on("mouseover", function(d) {
			div.transition()
				.duration(200)
				.style("opacity", .9);
			div.html(d.key + "<br/>Net Surplus: " + d.net_surplus + ", $" + Math.round(d.price_mhz_pop* 100) / 100)
				.style("left", (d3.event.pageX) + "px")
				.style("top", (d3.event.pageY - 28) + "px");
			})
		.on("mouseout", function(d) {
			div.transition()
				.duration(500)
				.style("opacity", 0);
		});

	d3.select("#rselect").on("change", function() {
		update(data, this.value);
	});

	var myTimer;
	d3.select("#start")
		.on("click", function() {
			clearInterval (myTimer);
			var b = d3.select("#rselect");
			myTimer = setInterval(function() {
				var t = (+b.property("value") + 1) % (+b.property("max") + 1);
				if (t == 0) { t = +b.property("min"); }
				b.property("value", t);
				update(data, t);
			}, 650);
	});

	d3.select("#stop").on("click", function() {
	    clearInterval (myTimer);
	});
});


function update(data, rselect) {
	var transition = svg.selectAll(".bar")
		.data(data.filter(function(d) {return d.round == rselect}));

	transition.enter().append("rect").attr("width", x.rangeBand());
	transition.exit().remove();

	transition.transition()
		.duration(420)
		.attr("fill", function(d) { return colors(d.price_mhz_pop)})
        .attr("x", function(d) { return x(d.key); })
        .attr("width", x.rangeBand())
		.attr("y", function(d) {
			if(d.net_surplus == 0){
				console.log(y(0) + 50);
				return (y(0)-2);
			} else{
				return y(Math.max(0, d.net_surplus));
			}
		})
		.attr("height", function(d) {
			if(d.net_surplus==0){
				return 4;
			} else{
				return Math.max(y(0) - y(d.net_surplus),y(d.net_surplus) - y(0));
			}
		});

	summary.text(function(){
		return round_text[Math.round(rselect/6)];
	});

	title.text(function(){ return "Round " +  rselect});
}

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-83437104-1', 'auto');
  ga('send', 'pageview');

</script>
<br />
<br />
<p style="color: #BBD; font-size: 0.7em;">Data from: <a href="https://auctiondata.fcc.gov/public/projects/1000/reports/product_status-stage1">FCC Public Reporting System</a></p>
</body>
</html>
