<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  position: relative;
  background-color: #011;
}

div.tooltip {
    position: absolute;
    text-align: center;
    padding: 3px;
    font: 14px sans-serif;
    background: #CFF;
    border: 0px;
    border-radius: 8px;
    pointer-events: none;
}

.bar:hover{
	fill: #66F;
}

.axis text {
  font: 8px sans-serif;
  fill: white;
  background-color: #011;
}

.tick {
	fill: white;
}

.axis path,
.axis line {
	stroke: #CCC;
	shape-rendering: crispEdges;
	fill: #021;
}

.bar {
	fill-opacity: .9;
}

.x.axis path {
  display: none;
}

label {
   position: absolute;
   top: 680px;
   left: 80px;
  color: #FFF;
}

</style>

<label for="rselect">Round
<input type="range" id="rselect" min="1" value="1" max="25" step="1">
<button type="button" id="start">start</button>
<button type="button" id="stop">stop</button>
</label>


<script src="//d3js.org/d3.v3.min.js"></script>
<script>


var round_text = ["Auction starts with high demand in top 10 markets.",
	"Bidding picking up in top 35.",
	"Bids spiking in PEAs 40-50.",
	"Bidding strong in New York and LA and 40-50.",
	"Eagle Pass, TX happens."];

var margin = {top: 50, right: 20, bottom: 20, left: 20},
	width = 1350 - margin.left - margin.right,
	height = 650 - margin.top - margin.bottom;

var x = d3.scale.ordinal().rangeRoundBands([0, width], .5);

var y = d3.scale.linear().range([height, 0]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
	.tickFormat(function (d) { return ''; });

var yAxis = d3.svg.axis()
    .scale(y)
    .orient("left")
	.innerTickSize(-width)
    .outerTickSize(0);
    //.tickFormat(formatPercent);

var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);

var svg = d3.select("body").append("svg")
		.attr("width", width + margin.left + margin.right)
		.attr("height", height + margin.top + margin.bottom)
	.append("g")
		.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var colors = d3.scale.linear()
    .domain([0.001, 1.8])
    .range(["#FFEFA0", "#A00040"])
	.clamp(true);

var title = svg.append("g")
		.attr("class", "title")
	.append("text")
		.attr("x", (width / 2))
		.attr("y", 12 - (margin.top / 2))
		.attr("text-anchor", "middle")
		.style("font-size", "25px")
		.style("fill", "white");

var summary = svg.append("g")
		.attr("class", "summary")
	.append("text")
		.attr("x", (3*width / 4))
		.attr("y", 80 - (margin.top / 2))
		.attr("text-anchor", "middle")
		.style("font-size", "16px")
		.style("fill", "white");

d3.csv("data.csv", function(error, data) {
	data.forEach(function(d) {
		d.round = +d.round;
		d.price_mhz_pop = +d.price_mhz_pop;
		d.net_surplus = +d.net_surplus;
	});

	x.domain(data.map(function(d) { return d.key; }));
	y.domain([-10, d3.max(data, function(d) { return d.net_surplus; })]);

	svg.append("g")
		.attr("class", "y axis")
		.call(yAxis)
	.append("text")
		.attr("transform", "rotate(-90)")
		.attr("y", 6)
		.attr("dy", ".71em")
		.style("text-anchor", "end")
		.text("Net Surplus");

	title.text(function(){ return "Round " +  document.getElementById("rselect").value});

	svg.selectAll(".bar")
		.data(data.filter(function(d) { return d.round == +document.getElementById("rselect").value}))
	.enter().append("rect")
		.attr("class", "bar")
		.attr("fill", function(d) { return colors(d.price_mhz_pop)})
		.attr("x", function(d) { return x(d.key); })
		.attr("width", x.rangeBand())
		.attr("y", function(d) {
			if(d.net_surplus == 0){
				console.log(y(0) + 50);
				return (y(0)-2);
			} else{
				return y(Math.max(0, d.net_surplus));
			}
		})
		.attr("height", function(d) {
			if(d.net_surplus==0){
				return 4;
			} else{
				return Math.max(y(0) - y(d.net_surplus),y(d.net_surplus) - y(0));
			}
		})
		.on("mouseover", function(d) {
			div.transition()
				.duration(200)
				.style("opacity", .9);
			div.html(d.key + "<br/>Net Surplus: " + d.net_surplus + ", $" + Math.round(d.price_mhz_pop* 100) / 100)
				.style("left", (d3.event.pageX) + "px")
				.style("top", (d3.event.pageY - 28) + "px");
			})
		.on("mouseout", function(d) {
			div.transition()
				.duration(500)
				.style("opacity", 0);
		});

	d3.select("#rselect").on("change", function() {
		update(data, this.value);
	});

	var myTimer;
	d3.select("#start")
		.on("click", function() {
			clearInterval (myTimer);
			var b = d3.select("#rselect");
			myTimer = setInterval(function() {
				var t = (+b.property("value") + 1) % (+b.property("max") + 1);
				if (t == 0) { t = +b.property("min"); }
				b.property("value", t);
				update(data, t);
			}, 650);
	});

	d3.select("#stop").on("click", function() {
	    clearInterval (myTimer);
	});
});


function update(data, rselect) {
	var transition = svg.selectAll(".bar")
		.data(data.filter(function(d) {return d.round == rselect}));

	transition.enter().append("rect").attr("width", x.rangeBand());
	transition.exit().remove();

	transition.transition()
		.duration(420)
		.attr("fill", function(d) { return colors(d.price_mhz_pop)})
        .attr("x", function(d) { return x(d.key); })
        .attr("width", x.rangeBand())
		.attr("y", function(d) {
			if(d.net_surplus == 0){
				console.log(y(0) + 50);
				return (y(0)-2);
			} else{
				return y(Math.max(0, d.net_surplus));
			}
		})
		.attr("height", function(d) {
			if(d.net_surplus==0){
				return 4;
			} else{
				return Math.max(y(0) - y(d.net_surplus),y(d.net_surplus) - y(0));
			}
		});

	summary.text(function(){
		return round_text[Math.round((rselect-1)/6)];
	});

	title.text(function(){ return "Round " +  rselect});
}

</script>
